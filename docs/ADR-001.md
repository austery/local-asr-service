---
specId: ADR-001
title: Local ASR Service 架构原则
Date: 2026-01-31 (Updated)
Status: ✅ Accepted
Context: Mac mini M4 Pro (64GB), Python 3.11+, FastAPI
Goal: 构建一个 **Production-Ready** 但保持 **MVP** 规模的本地语音转录服务，支持多种推理引擎。
---

## 1. Context (背景)

我们需要在本地运行高性能 ASR 模型。面临的挑战包括：
- **Apple Silicon 限制**: M4 芯片的统一内存架构 (UMA) 不适合多进程并发争抢显存。
- **引擎多样性**: 既需要支持阿里 FunASR (SenseVoiceSmall) 的高精度，也需要支持 Apple MLX (Whisper/Qwen3-ASR) 的原生加速和长音频处理。
- **稳定性要求**: 服务需长期运行，不能因为一次推理失败就崩溃。

## 2. Decision (决策)

### 2.1 采用 Clean Architecture (简化版)

严守分层，拒绝“脚本式”写法。

```

┌──────────────────────────────────────┐
│  API Layer (FastAPI Routers)         │  ← **入口层**
│  (Handle HTTP, Validation)           │     只做参数校验，立即返回 Future
└───────────────┬──────────────────────┘
│
┌───────────────▼──────────────────────┐
│  Service Layer (Async Queue Manager) │  ← **调度层** (核心)
│  (TranscriptionService)              │     管理并发，决定"谁先跑"
└───────────────┬──────────────────────┘
│
┌───────────────▼──────────────────────┐
│  Core Layer (Inference Engine)       │  ← **业务核心** (Factory + Protocol)
│  (EngineFactory -> ASREngine)        │     统一接口，封装 FunASR/MLX 差异
└───────────────┬──────────────────────┘
│
┌───────────────▼──────────────────────┐
│  Adapters / Infrastructure           │  ← **设施层**
│  (FFmpeg, Text Cleaning, Logging)    │     具体库的调用细节
└──────────────────────────────────────┘

```

### 2.2 核心约束 (Critical Constraints)

1.  **严格串行 (Strict Serial Execution)**:
    - **原因**: 针对 M4 Pro 优化。ASR 推理极快但显存密集，并发会导致 MPS 图编译抖动和显存争抢 (OOM)。
    - **实现**: 使用**单消费者 (Single Consumer)** 模式的 `asyncio.Queue`。禁止开启多线程推理。

2.  **双引擎架构 (Dual Engine Strategy)**:
    - **原因**: 不同的场景需要不同的模型优势（FunASR 适合中文短句，MLX 适合长音频和多语言）。
    - **实现**: 定义 `ASREngine` 协议 (Protocol)，通过环境变量 (`ENGINE_TYPE`) 在启动时注入具体的 `FunASREngine` 或 `MlxEngine`。

3.  **单例生命周期 (Singleton Lifecycle)**:
    - **原因**: 模型加载耗时且占内存。
    - **实现**: 引擎实例必须作为单例在 `Lifespan` (App Startup) 中初始化。

---

## 3. Consequences (后果)

- **优点**: 结构极其清晰，测试容易（Mock Engine 层即可测 API），完全杜绝了 OOM (内存溢出) 风险，且具备良好的扩展性（添加新引擎只需实现 Protocol）。
- **缺点**: 代码量比“脚本版”多出 30%，但这是为了“十分钟生成，零调试”所付出的必要成本。
